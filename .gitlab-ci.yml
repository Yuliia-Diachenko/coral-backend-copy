variables:
  GIT_DEPTH: 0
  BUILD_TAG_BASE: v1.0.${CI_PIPELINE_IID}${ENV}
  BACKEND_CONTAINER_NAME: coral-backend${ENV}
  PORT: 5000
  LOG_PATH: '/opt/coral/logs'

.docker-cleanup:
  script:
    - docker system prune -af

.release:
  script:
    - docker build -t $BACKEND_CONTAINER_NAME:$BUILD_TAG_BASE .
    - docker stop $BACKEND_CONTAINER_NAME || true
    - docker rm $BACKEND_CONTAINER_NAME || true
    - mkdir -p ${LOG_PATH}
    - chown 1000:1000 ${LOG_PATH} || true
    - docker run -d -p 127.0.0.1:${PORT}:3000 --network coral-network --restart always --name ${BACKEND_CONTAINER_NAME} -v ${LOG_PATH}:/var/log/app/:rw --env-file .env  $BACKEND_CONTAINER_NAME:$BUILD_TAG_BASE

Deploy-prod:
  stage: deploy
  only:
    - main
  tags:
    - coral-prod
  allow_failure: false
  before_script:
    - echo $ENV_BACK_PROD | base64 -d > .env
    - !reference [.docker-cleanup, script]
  script:
    - !reference [.release, script]